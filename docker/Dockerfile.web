# Stage 1: build the React app
FROM node:20-slim AS builder

WORKDIR /app

COPY apps/web-app/package.json apps/web-app/package-lock.json ./
RUN npm ci

COPY apps/web-app/ ./

# VITE_API_BASE_URL is injected at build time so the JS bundle knows
# where to send API requests. Set this in Railway's frontend service vars.
ARG VITE_API_BASE_URL
ARG VITE_USE_MOCK_API=false
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL
ENV VITE_USE_MOCK_API=$VITE_USE_MOCK_API

RUN npm run build

# Stage 2: serve with nginx
FROM nginx:1.27-alpine

RUN rm /etc/nginx/conf.d/default.conf

COPY docker/nginx.conf /etc/nginx/conf.d/default.conf.template
COPY --from=builder /app/dist /usr/share/nginx/html

# Railway injects $PORT at runtime. This script substitutes it into the
# nginx config template and then starts nginx.
COPY docker/nginx-entrypoint.sh /docker-entrypoint.d/99-railway-port.sh
RUN chmod +x /docker-entrypoint.d/99-railway-port.sh

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
