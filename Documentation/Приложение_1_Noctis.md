# ПРИЛОЖЕНИЕ 1

**ТЕМА:** Noctis: ML Backend за Инференция

**АВТОР 1:**
*   **Име:** `(Попълнете сами)`
*   **ЕГН:** `(Попълнете сами)`
*   **Адрес:** `(Попълнете сами)`
*   **GSM:** `(Попълнете сами)`
*   **E-mail:** `(Попълнете сами)`
*   **Специалност:** `(Попълнете сами)`

**АВТОР 2:**
*   **Име:** `(Попълнете сами)`
*   **ЕГН:** `(Попълнете сами)`
*   **Адрес:** `(Попълнете сами)`
*   **GSM:** `(Попълнете сами)`
*   **E-mail:** `(Попълнете сами)`
*   **Специалност:** `(Попълнете сами)`

**РЪКОВОДИТЕЛ:**
*   **Име:** `(Попълнете сами)`
*   **GSM:** `(Попълнете сами)`
*   **E-mail:** `(Попълнете сами)`
*   **Позиция:** `(Попълнете сами)`

---

### РЕЗЮМЕ:

#### Цели:
*   Да се предостави цялостна система (хардуер и софтуер) за надежден, високопроизводителен мониторинг и предсказване на фази на съня, където **хардуерното устройство изпраща данни към API, а локалното съхранение на флаш памет е само резервен вариант при липса на свързаност**.
*   Да се поддържа многопотребителска среда (multi-tenancy) със силна изолация на данните и сигурност в софтуерния бекенд.
*   Да се имплементира пълен MLOps жизнен цикъл като **гаранция за дългосрочна точност и надеждност**. Това включва версиониране на модели, презареждане в реално време и автоматизирана детекция на дрейф на концепцията (concept drift), които гарантират, че системата се адаптира към промени в данните и запазва своята прецизност.
*   Да се осигури стабилност и устойчивост на системата чрез функционалности като автоматични прекъсвачи (circuit breakers) към базата данни, таймаути на заявките и тестване чрез инжектиране на грешки (fault injection).
*   Да се улесни внедряването и мащабирането на софтуерната част чрез Docker и Gunicorn.

#### Основни етапи в реализиране на проекта:
*   **Проектиране и изработка на хардуера:** Избор на компоненти, дизайн на схемата, сглобяване на прототипа и проектиране на 3D модел за кутия.
*   **Проектиране на системата:** Дефиниране на софтуерната архитектура, схемата на базата данни, API договора и механизма за предаване на данни от хардуера към API.
*   **Разработка на Backend:** Имплементиране на приложението с FastAPI, включително API рутери, сервизен слой и интеграция с базата данни чрез SQLAlchemy и Alembic за миграции.
*   **Интеграция на ML модели:** Създаване на регистър за модели (Model Registry) за зареждане и обслужване на различни версии на моделите. Имплементиране на логиката за предсказване.
*   **MLOps функционалности:** Изграждане на модули за мониторинг (`/metrics`), детекция на дрейф, оценка на модели и тестове за устойчивост.
*   **Тестване:** Написване на цялостни unit, integration и load тестове за осигуряване на качеството на кода и производителността.
*   **Контейнеризация и внедряване:** Създаване на Dockerfile и `docker-compose` конфигурация за лесно и възпроизводимо внедряване.

#### Инженерни предизвикателства:
*   **Оптимизация на позиционирането на сензорите:** Разрешен е фундаментален конфликт между двата основни сензора. Радарният сензор изисква пряка видимост и разстояние (1-1.5м), докато акселерометърът изисква физически контакт с леглото за отчитане на вибрации. Решението се базира на анализ на компромиси, като се препоръчва монтаж под матрака (за матраци без метални пружини) или странично на рамката на леглото. Този подход балансира между качеството на сигнала от радара и чувствителността на акселерометъра.
*   **Гарантирана производителност в реално време:** Системата е проектирана да отговаря на ключов показател за ефективност (KPI) от **p95 времезакъснение < 350ms** при инференция. Това гарантира, че данните могат да бъдат анализирани почти мигновено, което е критично за бъдещи приложения като аларми или нотификации.
*   **Надеждност на потока данни и офлайн буфериране:** Осигурена е непрекъснатост на данните чрез интелигентен механизъм за предаване. Хардуерът приоритизира изпращането към API и само при липса на връзка активира резервен механизъм - запис върху **8MB вградена флаш памет**. Този капацитет служи като ключов показател (KPI) за автономност, позволявайки съхранение на данни за до 189 дни без връзка.
*   **Безопасно презареждане на ML модели (Zero-Downtime):** Имплементиран е `thread-safe` механизъм за актуализация на моделите в реално време. Това е критично за 24/7 мониторинг, тъй като позволява на системата да се обновява с нови, по-точни модели, без да се прекъсва обслужването на заявки и без да се губят данни от анализ.
*   **Мащабируемо управление на времеви редове данни:** Ефективното управление на големи обеми от данни (епохи) в TimescaleDB е решено чрез използването на автоматични политики за компресия и задържане (retention), както и специализирани хипертаблици, които осигуряват висока производителност при запис и четене.
*   **Сигурност:** Проектиране и налагане на стабилен модел за многопотребителска автентикация и оторизация чрез JWT.

---

### Логическо и функционално описание на решението:

#### Архитектура
Системата Noctis се състои от два основни компонента: **хардуерно устройство за мониторинг** и **софтуерен backend**.

**1. Хардуерен компонент:** Физическо устройство, което събира данни по време на сън (чрез ESP32 микроконтролер, 60GHz mmWave радар за жизнени показатели и MPU6050 акселерометър за движение). То **първоначално се опитва да изпрати данните към софтуерния API**. При невъзможност за връзка, данните временно се съхраняват на вградена 8MB флаш памет, за да бъдат изпратени по-късно.

**2. Софтуерен компонент (Backend):** Backend API услуга, която приема данните от хардуера (директно или от флаш паметта), извършва анализ и предсказване. Взаимодействието се осъществява програмно чрез REST API извиквания. Архитектурата на софтуера се състои от няколко ключови компонента:
*   **FastAPI рутери:** Обработват входящите HTTP заявки и ги насочват към съответните услуги.
*   **Сервизен слой:** Съдържа основната бизнес логика за функционалности като предсказване и анализ на дрейф.
*   **SQLAlchemy + TimescaleDB:** Осигурява слоя за съхранение на данни.
*   **Регистър на модели (Model Registry):** Файлово-базиран регистър, който съхранява и управлява различни версии на ML моделите. Това служи като ключов елемент за надеждност, позволявайки възпроизводимост на резултатите, лесен `rollback` към предишни версии при нужда и гарантира, че системата винаги използва одобрен и тестван модел.

`[ВМЪКНЕТЕ КАРТИНКА ТУК: Диаграма на цялостната архитектура - от хардуера до софтуера, включително потока на данни.]`

#### Поток на данните (Data Flow)
Процесът на движение на данните е проектиран за максимална надеждност:
1.  **Събиране:** На всеки 30 секунди, ESP32 микроконтролерът събира данни от радарния сензор и акселерометъра.
2.  **Обработка:** Суровите данни се обработват в 15-мерен вектор (епоха), готов за анализ.
3.  **Опит за предаване:** Устройството се опитва да изпрати новосъздадената епоха към `/v1/epochs:ingest` ендпойнта на FastAPI бекенда.
4.  **Резервен запис (Fallback):** Ако API е недостъпен (липса на Wi-Fi), епохата се записва в опашка на вградената 8MB флаш памет.
5.  **Синхронизация:** При възстановяване на връзката, устройството автоматично изпраща натрупаните в паметта епохи към API, за да се гарантира, че няма загуба на данни.
6.  **Инференция и съхранение:** След като данните постъпят в бекенда, те се съхраняват в TimescaleDB и могат да бъдат използвани за инференция чрез `/v1/predict` ендпойнта.

#### Хардуер: Устройство за Мониторинг на Съня Noctis

Източникът на данни за системата е специално създадено хардуерно устройство, което следи съня на потребителя.

*   **Основни компоненти:** Устройството е базирано на микроконтролер ESP32 и използва 60GHz милиметров радарен сензор (за отчитане на сърдечен ритъм, дишане и присъствие) и акселерометър MPU6050 (за проследяване на движения и вибрации).
*   **Обработка на данни:** Микроконтролерът ESP32 обработва суровите данни от сензорите в 30-секундни епохи, всяка от които съдържа вектор от 15 характеристики.
*   **Предаване и съхранение на данни:** Устройството е проектирано да изпраща събраните данни към софтуерния API при наличие на мрежова свързаност. В случай на невъзможност за връзка, данните временно се съхраняват на вградена 8MB флаш памет, за да бъдат изпратени по-късно.
*   **Физически дизайн:** Компонентите са поместени в персонализирана кутия, отпечатана на 3D принтер, чиито дизайн файлове са налични в проекта.

`[ВМЪКНЕТЕ КАРТИНКА ТУК: Снимка на сглобеното устройство Noctis Sleep Monitor.]`

`[ВМЪКНЕТE КАРТИНКА ТУК: Рендър или снимка на 3D модела на кутията.]`

#### API Ендпойнти (вместо страници)
*   **`/healthz`, `/readyz`, `/metrics`:** Ендпойнти без автентикация за здравни проверки и метрики за Prometheus.
*   **`/v1/epochs:ingest`:** Ендпойнт за въвеждане на нови данни за епохи в системата.
*   **`/v1/predict`:** Основният ендпойнт за получаване на предсказания за фази на съня от активния модел.
*   **`/v1/model/drift`:** Ендпойнт, който служи като система за ранно предупреждение. Той предоставя отчет за текущия дрейф на модела, позволявайки проактивна намеса и преобучение, преди точността на предсказанията да се е влошила значително.
*   **`/internal/...`:** Набор от ендпойнти за вътрешни операции като стартиране на стрес тестове, управление на политиките на базата данни и инжектиране на грешки за тестване на устойчивостта.

`[ВМЪКНЕТЕ КАРТИНКА ТУК: Примерна заявка с curl към /v1/predict и полученият JSON отговор]`

---

### Реализация:

#### Използвани технологии:
*   **Backend:** Python 3.11+, FastAPI
*   **Уеб сървър:** Uvicorn, Gunicorn
*   **База данни:** TimescaleDB (разширение за PostgreSQL)
*   **Достъп до данни:** SQLAlchemy (ORM), Alembic (миграции)
*   **Машинно обучение:** NumPy, Scikit-learn
*   **Контейнеризация:** Docker, Docker Compose
*   **Тестване:** Pytest

---

### Описание на приложението
*   Достъпът до приложението се осъществява през уеб сървър (напр. `http://localhost:8000`, когато се изпълнява локално). Взаимодействието се извършва чрез API извиквания от клиентско приложение или с инструменти като `curl`.
*   Основният работен процес включва:
    1.  Автентикация за получаване на JWT токен.
    2.  Въвеждане на данни за записи и епохи чрез ендпойнтите `/v1/devices`, `/v1/recordings`, и `/v1/epochs:ingest`.
    3.  Заявяване на предсказания за въведените данни чрез ендпойнта `/v1/predict`.
    4.  Мониторинг на производителността и дрейфа на модела чрез ендпойнтите `/v1/model/drift` и `/metrics`.

---

### Заключение
*   Проектът предоставя стабилно и мащабируемо backend решение за обслужване на модели за предсказване на фази на съня. Той включва изчерпателен набор от MLOps функционалности, които са от решаващо значение за поддържане на качеството и производителността на модела в производствена среда.

#### Бъдеще на проекта:
*   Разширяване на регистъра на моделите, за да поддържа по-голямо разнообразие от архитектури на модели.
*   Създаване на специализирано табло за управление (напр. с Grafana) за визуализация на метриките от ендпойнта `/metrics`.
*   Добавяне на поддръжка за приемане на данни в реално време (напр. чрез WebSockets или Kafka).
*   Разработване на по-усъвършенствани функции за детекция на дрейф и обяснимост (explainability).
*   Създаване на клиентски SDK (напр. Python библиотека), за да се улесни взаимодействието с API-то.
