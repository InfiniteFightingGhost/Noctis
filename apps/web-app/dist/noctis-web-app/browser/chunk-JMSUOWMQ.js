import{Cb as f,I as n,M as r,ba as u,c as i,lb as c,o as a}from"./chunk-VHPO65OP.js";var d=(()=>{class t{api=r(f);register(e){return this.api.post("/v1/auth/register",e)}login(e){return this.api.post("/v1/auth/login",e)}me(){return this.api.get("/v1/auth/me")}static \u0275fac=function(s){return new(s||t)};static \u0275prov=n({token:t,factory:t.\u0275fac,providedIn:"root"})}return t})();var g=(()=>{class t{session=u(null);accessToken=c(()=>this.session()?.accessToken??null);scopes=c(()=>this.session()?.scopes??[]);isAuthenticated=c(()=>!!this.accessToken());setSession(e){this.session.set(e)}clearSession(){this.session.set(null)}static \u0275fac=function(s){return new(s||t)};static \u0275prov=n({token:t,factory:t.\u0275fac,providedIn:"root"})}return t})();var D=(()=>{class t{store=r(g);api=r(d);isAuthenticated(){return this.store.isAuthenticated()}getAccessToken(){return this.store.accessToken()}getScopes(){return this.store.scopes()}getSession(){return this.store.session()}hasScopes(e){if(e.length===0)return!0;let s=new Set(this.store.scopes());return e.every(o=>s.has(o))}setSession(e){this.store.setSession(e)}setAccessToken(e,s=[]){this.setSession({accessToken:e,scopes:s})}clearSession(){this.store.clearSession()}login(e,s){return i(this,null,function*(){let o=yield a(this.api.login({email:e,password:s})),p=this.parseAccessToken(o);this.store.setSession({accessToken:p,scopes:[]});try{yield this.refreshSessionProfile()}catch(h){throw this.store.clearSession(),h}})}signup(e,s){return i(this,null,function*(){let o=yield a(this.api.register({email:e,password:s})),p=this.parseAccessToken(o);this.store.setSession({accessToken:p,scopes:[]});try{yield this.refreshSessionProfile()}catch(h){throw this.store.clearSession(),h}})}refreshSessionProfile(){return i(this,null,function*(){let e=yield a(this.api.me()),s=this.store.session();s&&this.store.setSession({accessToken:s.accessToken,scopes:this.parseScopes(e.scopes),tenantId:this.parseTenantId(e)})})}parseAccessToken(e){if(!e||typeof e!="object")throw new Error("Login failed. Please try again.");let s=e,o=typeof s.access_token=="string"?s.access_token:typeof s.accessToken=="string"?s.accessToken:null;if(!o)throw new Error("Login failed. Please try again.");return o}parseScopes(e){return Array.isArray(e)?e.filter(s=>typeof s=="string"):[]}parseTenantId(e){if(!e||typeof e!="object")return null;let s=e;return typeof s.tenant_id=="string"?s.tenant_id:typeof s.tenantId=="string"?s.tenantId:null}static \u0275fac=function(s){return new(s||t)};static \u0275prov=n({token:t,factory:t.\u0275fac,providedIn:"root"})}return t})();export{D as a};
